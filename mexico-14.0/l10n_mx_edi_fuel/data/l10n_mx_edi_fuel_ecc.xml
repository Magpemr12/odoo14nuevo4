<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="l10n_mx_edi_fuel_ecc">
        <cfdi:Complemento
            xmlns:cfdi="http://www.sat.gob.mx/cfd/3"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <ecc12:EstadoDeCuentaCombustible
                xsi:schemaLocation="
                http://www.sat.gob.mx/EstadoDeCuentaCombustible12
                http://www.sat.gob.mx/sitio_internet/cfd/EstadoDeCuentaCombustible/ecc12.xsd"
                xmlns:ecc12="http://www.sat.gob.mx/EstadoDeCuentaCombustible12"
                Version="1.2"
                TipoOperacion="Tarjeta"
                t-att-NumeroDeCuenta="record.partner_bank_id.acc_number"
                t-att-SubTotal="format_float(fuel_amount_untaxed, 2)"
                t-att-Total="format_float(fuel_amount_total, 2)">
                <ecc12:Conceptos>
                <t t-foreach="fuel_lines" t-as="line">
                    <ecc12:ConceptoEstadoDeCuentaCombustible
                        t-att-Identificador="record.partner_id.ref"
                        t-att-Fecha="cfdi_date"
                        t-att-Rfc="line.l10n_mx_edi_fuel_partner_id.vat or record.company_id.vat"
                        t-att-ClaveEstacion="line.l10n_mx_edi_fuel_partner_id.ref or record.company_id.partner_id.ref"
                        t-att-Cantidad="line.quantity"
                        t-att-TipoCombustible="line.product_id.default_code"
                        t-att-Unidad="(line.product_uom_id.name or '')[:20]"
                        t-att-NombreCombustible="(line.name or '')[:1000]"
                        t-att-FolioOperacion="folio_number"
                        t-att-ValorUnitario="format_float(line.price_unit, currency_precision)"
                        t-att-Importe="format_float(record.currency_id.round(line.price_unit * line.quantity), currency_precision)">
                        <t t-set="taxes_line" t-value="line.tax_ids"/>
                            <t t-if="taxes_line">
                            <t t-set="transferred" t-value="taxes_line.filtered(lambda r: r.amount &gt;= 0)"/>
                                <t t-if="transferred">
                                    <ecc12:Traslados>
                                    <t t-foreach="transferred" t-as="tax">
                                        <ecc12:Traslado
                                            t-att-Impuesto="tax.mapped('invoice_repartition_line_ids.tag_ids').name if tax.mapped('invoice_repartition_line_ids.tag_ids') else ''"
                                            t-att-TasaOCuota="format_float(abs(tax.amount / 100.0), 6) if tax.l10n_mx_tax_type != 'Exento' else False"
                                            t-att-Importe="format_float(abs(tax.amount / 100.0 * line.price_subtotal), 2) if tax.l10n_mx_tax_type != 'Exento' else False"/>
                                    </t>
                                    </ecc12:Traslados>
                                </t>
                            </t>
                    </ecc12:ConceptoEstadoDeCuentaCombustible>
                </t>
                </ecc12:Conceptos>
            </ecc12:EstadoDeCuentaCombustible>
        </cfdi:Complemento>
    </template>
</odoo>
